<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Leaf Classification</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* keep only basic table/metrics helpers here; layout and panels are handled in static/styles.css */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid rgba(255,255,255,0.06);
            padding: 8px 12px;
            text-align: center;
            color: #e9eef6;
        }
        th {
            background-color: rgba(255,255,255,0.02);
        }
        .metrics { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="page">
        <header class="site-header">
            <div class="header-bar">COFFEE LEAF DISEASE CLASSIFICATION</div>
        </header>

        <main class="main-content">
            <aside class="sidebar" id="sidebar">
                <div class="collapse-toggle" id="collapseToggle">☰</div>
                <div class="panel">
                    <div class="panel-title">Classes</div>
                    <div class="panel-body" id="classesList">
                        {% if labels %}
                            {% for lbl in labels %}
                                <div class="class-row" data-label="{{ lbl|lower }}">
                                    <span class="class-dot"></span>
                                    <span class="class-name">{{ lbl.replace('_',' ') | title }}</span>
                                    <span class="class-count"></span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="muted">No class labels found</div>
                        {% endif %}
                    </div>
                </div>
                {% if result and (result.predictions or result.raw_label) %}
                <div class="panel" id="accuracyPanel">
                    <div class="panel-title">Accuracy</div>
                    <div class="panel-body" id="layersList">
                        {% if result and result.predictions %}
                            {% for p in result.predictions %}
                                <div class="layer-row" data-label="{{ p.label|lower }}">{{ p.label.replace('_',' ') | title }} — {{ (p.confidence*100)|round(1) }}%</div>
                            {% endfor %}
                        {% elif result and result.raw_label %}
                            <div class="layer-row" data-label="{{ result.raw_label|lower }}">{{ result.raw_label.replace('_',' ') | title }} — {{ (result.confidence*100)|round(1) }}%</div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <!-- small spacer when no layers to avoid large empty box -->
                <div style="height:12px"></div>
                {% endif %}
            </aside>
            <section class="upload-wrap">
                <form action="/" method="post" enctype="multipart/form-data" id="predictForm" class="upload-section">
                    <input type="hidden" name="action" id="actionField" value="">
                    <div class="upload-box">
                        <label class="upload-drop">
                            <span class="upload-title">Upload here</span>
                            <span class="upload-sub">PNG or JPG</span>
                            <span class="upload-btn">Choose Image</span>
                            <input id="fileInput" type="file" name="file" accept="image/*" multiple onchange="previewImage(event)">
                        </label>
                        <div class="no-file" id="noFile">
                            <div id="fileListWrap">
                                <ul id="fileList" class="file-list"></ul>
                                <div id="fileListEmpty" class="file-empty">{% if selected_filename %}{{ selected_filename }}{% endif %}</div>
                            </div>
                            <button type="button" id="removeBtn" class="remove-btn" style="{% if selected_filename %}display:inline-block;{% else %}display:none;{% endif %}">✕</button>
                        </div>
                    </div>
                    <button type="submit" id="detectButton" class="detect-btn" style="display:none;">→</button>
                    <button type="button" id="tryButton" class="try-btn" style="display:none; margin-left:8px;">Try This Model</button>
                </form>
            </section>

            <!-- Model metrics intentionally hidden; PNGs remain in static/ -->

            <section id="resultWrap" class="result-wrap {% if batch_results %}result-wrap--batch{% endif %}" style="{% if result or image_url or batch_results %}display:block;{% else %}display:none;{% endif %}">
                {% if batch_results %}
                    <div class="result-card result-card--batch">
                        <div class="result-title">Result</div>
                        <div class="result-grid">
                            {% for item in batch_results %}
                                {% set item_label = item.raw_label if item.raw_label else item.class_label %}
                                {% set item_label_key = item_label|lower|replace(' ', '_') %}
                                <div class="result-image" data-top-label="{{ item_label_key }}" data-class-label="{{ item.class_label }}" data-confidence="{{ (item.confidence * 100) | round(1) }}">
                                    <img src="{{ item.image_url }}" alt="Uploaded Image" />
                                    <div class="image-overlay">
                                        <div class="overlay-chip">
                                            <div class="overlay-value">{{ item.class_label }}</div>
                                            <div class="overlay-sub">{{ (item.confidence * 100) | round(1) }}%</div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                <div class="result-card" {% if top_label %}data-top-label="{{ top_label }}"{% endif %}>
                    <div class="result-title">Result <span class="result-dot" aria-hidden="true"></span></div>
                    {% set top_label = None %}
                    {% set top_pred_label = None %}
                    {% set top_pred_conf = None %}
                    {% if result and result.predictions %}
                        {% set max_conf = -1.0 %}
                        {% for p in result.predictions %}
                            {% if p.confidence is defined %}
                                {% if (p.confidence|float) > (max_conf|float) %}
                                    {% set max_conf = p.confidence|float %}
                                    {% set top_label = p.label|lower %}
                                    {% set top_pred_label = p.label %}
                                    {% set top_pred_conf = p.confidence %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% elif result and result.class_label %}
                        {% if result.raw_label %}
                            {% set top_label = result.raw_label|lower|replace(' ', '_') %}
                        {% else %}
                            {% set top_label = result.class_label|lower|replace(' ', '_') %}
                        {% endif %}
                    {% endif %}
                    <div class="result-image" {% if top_label %}data-top-label="{{ top_label }}"{% endif %} data-class-label="{% if result and result.class_label %}{{ result.class_label }}{% elif result and result.predictions and top_pred_label %}{{ top_pred_label.replace('_',' ') | title }}{% endif %}" data-confidence="{% if result and result.class_label %}{{ (result.confidence * 100) | round(1) }}{% elif result and result.predictions and top_pred_conf %}{{ (top_pred_conf * 100) | round(1) }}{% endif %}">
                                {% if image_url %}
                                    <img src="{{ image_url }}" alt="Uploaded Image" />
                                {% else %}
                                    <img id="preview" style="display:none;" />
                                {% endif %}
                                {% if result and result.class_label %}
                                    <div class="image-overlay">
                                        <div class="overlay-chip">
                                            <div class="overlay-value">{{ result.class_label }}</div>
                                            <div class="overlay-sub">{{ (result.confidence * 100) | round(1) }}%</div>
                                        </div>
                                    </div>
                                {% elif result and result.predictions and top_pred_label %}
                                    <div class="image-overlay">
                                        <div class="overlay-chip">
                                            <div class="overlay-value">{{ top_pred_label.replace('_',' ') | title }}</div>
                                            <div class="overlay-sub">{{ (top_pred_conf * 100) | round(1) }}%</div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                    <div class="result-info">
                        {% if result and result.class_label %}
                        {% elif result and result.predictions %}
                            <div class="info-row"><span class="label">CLASSIFICATION:</span></div>
                            <div class="threshold-control">
                                <label for="thresholdSlider">Confidence threshold: <span id="thresholdValue">50%</span></label>
                                <input id="thresholdSlider" type="range" min="0" max="100" value="50">
                            </div>
                            <div class="pred-list" id="predList">
                                {% for p in result.predictions %}
                                        <div class="pred-item" data-confidence="{{ p.confidence }}">
                                            <div class="pred-row">
                                                <strong class="pred-label">{{ p.label.replace('_',' ') | title }}</strong>
                                                <span class="conf-val">{{ (p.confidence * 100) | round(1) }}%</span>
                                            </div>
                                            <div class="pred-bar"><div class="pred-fill" style="width: {{ (p.confidence*100)|round(0) }}%"></div></div>
                                        </div>
                                    {% endfor %}
                            </div>
                        {% else %}
                            <div class="info-row"><span class="label">CLASSIFICATION:</span> <span class="value" id="resultClassification">-</span></div>
                            <div class="info-row"><span class="label">ACCURACY:</span> <span class="value" id="resultAccuracy">-</span></div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </section>
        </main>
    </div>

    <div id="imageModal" class="image-modal" aria-hidden="true">
        <button class="image-modal-close" id="imageModalClose" aria-label="Close">×</button>
        <div class="image-modal-content">
            <img id="imageModalImg" alt="Result preview" />
            <div class="image-modal-label" id="imageModalLabel"></div>
        </div>
    </div>

    <script>
        // Show filename in upload box and prevent submit if no file selected
        // Keep a client-side list so users can add files in multiple clicks
        let selectedFilesCache = [];

        function fileKey(f) {
            return `${f.name}::${f.size}::${f.lastModified}`;
        }

        function renderFileList() {
            const removeBtn = document.getElementById('removeBtn');
            const detectBtn = document.getElementById('detectButton');
            const fileList = document.getElementById('fileList');
            const fileListEmpty = document.getElementById('fileListEmpty');

            fileList.innerHTML = '';
            if (selectedFilesCache.length > 0) {
                selectedFilesCache.forEach(function (f, idx) {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <span class="file-name" title="${f.name}">${f.name}</span>
                        <button type="button" class="file-remove" data-index="${idx}" aria-label="Remove">×</button>
                    `;
                    fileList.appendChild(li);
                });
                fileListEmpty.textContent = '';
                removeBtn.style.display = 'inline-block';
                if (detectBtn) detectBtn.style.display = 'inline-block';
            } else {
                fileListEmpty.textContent = '';
                removeBtn.style.display = 'none';
                if (detectBtn) detectBtn.style.display = 'none';
            }
        }

        function syncInputFiles(fileInput) {
            const dt = new DataTransfer();
            selectedFilesCache.forEach(f => dt.items.add(f));
            fileInput.files = dt.files;
        }

        function previewImage(event) {
            const input = event.target;
            const incoming = Array.from(input.files || []);
            if (incoming.length) {
                const existing = new Set(selectedFilesCache.map(fileKey));
                incoming.forEach(function (f) {
                    const key = fileKey(f);
                    if (!existing.has(key)) {
                        selectedFilesCache.push(f);
                    }
                });
            }
            syncInputFiles(input);
            renderFileList();
        }

        // Client-side form submit handler: if no file chosen, prevent submit and update result card
            document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('predictForm');
            const fileInput = document.getElementById('fileInput');
            const noFile = document.getElementById('noFile');
            const resultClassification = document.getElementById('resultClassification');
            const resultAccuracy = document.getElementById('resultAccuracy');
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('imageModalImg');
            const modalClose = document.getElementById('imageModalClose');

            // Remove button clears the file input and resets UI
            const removeBtn = document.getElementById('removeBtn');
            const fileList = document.getElementById('fileList');
            const fileListEmpty = document.getElementById('fileListEmpty');
            removeBtn.addEventListener('click', function () {
                if (fileInput) {
                    fileInput.value = '';
                }
                selectedFilesCache = [];
                if (fileList) fileList.innerHTML = '';
                if (fileListEmpty) fileListEmpty.textContent = '';
                removeBtn.style.display = 'none';
                const detectBtn = document.getElementById('detectButton');
                if (detectBtn) detectBtn.style.display = 'none';
                // hide result panel when the user clears selection
                const resultWrap = document.getElementById('resultWrap');
                if (resultWrap) resultWrap.style.display = 'none';
                // hide accuracy panel on the left
                const accuracyPanel = document.getElementById('accuracyPanel');
                if (accuracyPanel) accuracyPanel.style.display = 'none';
                const layersList = document.getElementById('layersList');
                if (layersList) layersList.innerHTML = '';
                // clear class highlights
                const classRows = document.querySelectorAll('#classesList .class-row.active');
                classRows.forEach(function (row) {
                    row.classList.remove('active');
                    const countSpan = row.querySelector('.class-count');
                    if (countSpan) countSpan.textContent = '';
                });
            });

            // Remove individual file from selection
            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.file-remove');
                if (!btn || !fileInput) return;
                const idx = parseInt(btn.getAttribute('data-index'), 10);
                if (isNaN(idx) || idx < 0 || idx >= selectedFilesCache.length) return;
                selectedFilesCache.splice(idx, 1);
                syncInputFiles(fileInput);
                renderFileList();
                if (selectedFilesCache.length === 0) {
                    removeBtn.style.display = 'none';
                    const detectBtn = document.getElementById('detectButton');
                    if (detectBtn) detectBtn.style.display = 'none';
                }
            });
            

            form.addEventListener('submit', function (e) {
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                    e.preventDefault();
                    // show message in upload box and result card
                    const fileListEmpty = document.getElementById('fileListEmpty');
                    if (fileListEmpty) fileListEmpty.textContent = 'No file chosen';
                    resultClassification.textContent = 'No file chosen';
                    resultAccuracy.textContent = '-';
                    // show the result panel so user sees the message
                    const resultWrap = document.getElementById('resultWrap');
                    if (resultWrap) resultWrap.style.display = 'block';
                    return false;
                }
                // allow form submit; server will return result and reload page
                return true;
            });

            // If the page loads with a result already present, scroll the result into view
            const resultWrap = document.getElementById('resultWrap');
            if (resultWrap && resultWrap.style.display !== 'none') {
                // bring the result card to the center of the viewport
                resultWrap.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Confidence threshold slider: filter prediction items by their data-confidence
            const slider = document.getElementById('thresholdSlider');
            const threshVal = document.getElementById('thresholdValue');
            const predList = document.getElementById('predList');
            function applyThreshold() {
                if (!predList) return;
                const threshold = (slider ? parseInt(slider.value) / 100.0 : 0.5);
                const items = predList.querySelectorAll('.pred-item');
                let shown = 0;
                items.forEach(function(it){
                    const conf = parseFloat(it.getAttribute('data-confidence')) || 0.0;
                    if (conf >= threshold) {
                        it.style.display = '';
                        shown += 1;
                    } else {
                        it.style.display = 'none';
                    }
                });
                threshVal.textContent = Math.round(threshold * 100) + '%';
                // If none shown, reveal the top-confidence item to give feedback
                if (shown === 0 && items.length > 0) {
                    // find max
                    let maxIt = items[0];
                    let maxVal = parseFloat(maxIt.getAttribute('data-confidence')) || 0.0;
                    items.forEach(function(it){
                        const v = parseFloat(it.getAttribute('data-confidence')) || 0.0;
                        if (v > maxVal) { maxVal = v; maxIt = it; }
                    });
                    maxIt.style.display = '';
                }
            }
            if (slider) {
                slider.addEventListener('input', applyThreshold);
                applyThreshold();
            }

            // Image click to zoom (single + batch)
            document.addEventListener('click', function (e) {
                const img = e.target.closest('.result-image img');
                if (!img || !modal || !modalImg) return;
                const wrap = img.closest('.result-image');
                const label = wrap ? (wrap.getAttribute('data-class-label') || '').trim() : '';
                const conf = wrap ? (wrap.getAttribute('data-confidence') || '').trim() : '';
                const topLabel = wrap ? (wrap.getAttribute('data-top-label') || '').trim() : '';
                const labelEl = document.getElementById('imageModalLabel');
                if (labelEl) {
                    labelEl.textContent = label && conf ? `${label} ${conf}%` : label;
                }
                modalImg.src = img.src;
                if (topLabel) {
                    modal.setAttribute('data-top-label', topLabel);
                } else {
                    modal.removeAttribute('data-top-label');
                }
                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
            });

            function closeModal() {
                if (!modal) return;
                modal.classList.remove('open');
                modal.setAttribute('aria-hidden', 'true');
                modal.removeAttribute('data-top-label');
                if (modalImg) modalImg.src = '';
            }

            if (modalClose) {
                modalClose.addEventListener('click', closeModal);
            }
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) closeModal();
                });
            }
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') closeModal();
            });
        });
    </script>
    <script>
        // Sidebar: highlight classes that appear in current prediction and populate counts
        document.addEventListener('DOMContentLoaded', function(){
            try {
                const classes = document.querySelectorAll('#classesList .class-row');
                const layers = Array.from(document.querySelectorAll('#layersList .layer-row'));
                const batchImages = Array.from(document.querySelectorAll('.result-grid .result-image'));
                // collect labels from layers or batch images
                const active = layers.length
                    ? layers.map(l => (l.getAttribute('data-label')||'').toLowerCase())
                    : batchImages.map(img => (img.getAttribute('data-top-label')||'').toLowerCase());
                const counts = {};
                active.forEach(function(lbl){
                    if (!lbl) return;
                    counts[lbl] = (counts[lbl] || 0) + 1;
                });
                classes.forEach(function(cr){
                    const lbl = (cr.getAttribute('data-label')||'').toLowerCase();
                    const countSpan = cr.querySelector('.class-count');
                    const count = counts[lbl] || 0;
                    if (count > 0) {
                        cr.classList.add('active');
                        if (countSpan) countSpan.textContent = `(${count})`;
                    } else {
                        cr.classList.remove('active');
                        if (countSpan) countSpan.textContent = '';
                    }
                });

                // Collapse toggle
                const sidebar = document.getElementById('sidebar');
                const toggle = document.getElementById('collapseToggle');
                if (toggle && sidebar) {
                    toggle.addEventListener('click', function(){
                        sidebar.classList.toggle('collapsed');
                    });
                }
            } catch (e) {
                // ignore JS errors silently
            }
        });
    </script>
    <script>
        // Ensure the result image gets a data-top-label based on the highest-confidence prediction
        // This is a client-side fallback in case the server didn't set the attribute.
        document.addEventListener('DOMContentLoaded', function () {
            try {
                const resultImage = document.querySelector('.result-image');
                if (!resultImage) return;
                // If server already set it, keep it
                if (resultImage.getAttribute('data-top-label')) return;

                const predItems = Array.from(document.querySelectorAll('#predList .pred-item'));
                if (predItems.length === 0) return;

                let maxConf = -1;
                let topLabel = null;
                predItems.forEach(function (it) {
                    const conf = parseFloat(it.getAttribute('data-confidence')) || 0;
                    if (conf > maxConf) {
                        maxConf = conf;
                        const labelEl = it.querySelector('.pred-label');
                        if (labelEl) {
                            topLabel = labelEl.textContent.trim().toLowerCase().replace(/\s+/g, '_');
                        }
                    }
                });

                if (topLabel) {
                    resultImage.setAttribute('data-top-label', topLabel);
                }
            } catch (e) {
                // ignore
            }
        });
    </script>
    <script>
        // Copy data-top-label from the image wrapper to the result card so the dot updates
        document.addEventListener('DOMContentLoaded', function () {
            try {
                const imgWrap = document.querySelector('.result-image');
                const card = document.querySelector('.result-card');
                if (imgWrap && card) {
                    const lbl = imgWrap.getAttribute('data-top-label');
                    if (lbl) card.setAttribute('data-top-label', lbl);
                }
            } catch (e) { }
        });
    </script>
    <script>
        // Randomize overlay position inside the image bounds (supports batch)
        document.addEventListener('DOMContentLoaded', function () {
            try {
                const wraps = document.querySelectorAll('.result-image');
                if (!wraps.length) return;

                wraps.forEach(function (wrap) {
                    const overlay = wrap.querySelector('.image-overlay');
                    const img = wrap.querySelector('img');
                    if (!overlay || !img) return;

                    function setOverlayContrast() {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d', { willReadFrequently: true });
                            if (!ctx) return;
                            const w = img.naturalWidth || img.width;
                            const h = img.naturalHeight || img.height;
                            if (!w || !h) return;
                            canvas.width = w;
                            canvas.height = h;
                            ctx.drawImage(img, 0, 0, w, h);
                            const data = ctx.getImageData(0, 0, w, h).data;
                            let sum = 0;
                            let count = 0;
                            // sample every ~20px to keep it fast
                            const step = Math.max(1, Math.floor((w * h) / 4000));
                            for (let i = 0; i < data.length; i += 4 * step) {
                                const r = data[i];
                                const g = data[i + 1];
                                const b = data[i + 2];
                                // perceived luminance
                                const lum = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                                sum += lum;
                                count += 1;
                            }
                            const avg = count ? (sum / count) : 128;
                            // Toggle text style based on brightness
                            if (avg < 130) {
                                overlay.classList.add('overlay-light-text');
                                overlay.classList.remove('overlay-dark-text');
                            } else {
                                overlay.classList.add('overlay-dark-text');
                                overlay.classList.remove('overlay-light-text');
                            }
                        } catch (e) { }
                    }

                    function placeOverlay() {
                        const wrapRect = wrap.getBoundingClientRect();
                        const imgRect = img.getBoundingClientRect();
                        const overlayW = overlay.offsetWidth;
                        const overlayH = overlay.offsetHeight;

                        // Offset of the image inside the wrapper (accounts for padding)
                        const imgOffsetLeft = Math.max(0, imgRect.left - wrapRect.left);
                        const imgOffsetTop = Math.max(0, imgRect.top - wrapRect.top);
                        const imgW = imgRect.width;
                        const imgH = imgRect.height;

                        if (imgW <= 0 || imgH <= 0) return;

                        const maxLeft = Math.max(imgOffsetLeft, imgOffsetLeft + imgW - overlayW);
                        const maxTop = Math.max(imgOffsetTop, imgOffsetTop + imgH - overlayH);

                        const minLeft = imgOffsetLeft;
                        const minTop = imgOffsetTop;

                        const left = minLeft + Math.random() * (maxLeft - minLeft || 0);
                        const top = minTop + Math.random() * (maxTop - minTop || 0);

                        overlay.style.left = Math.round(left) + 'px';
                        overlay.style.top = Math.round(top) + 'px';
                    }

                    if (img.complete) {
                        placeOverlay();
                        setOverlayContrast();
                    } else {
                        img.addEventListener('load', function () {
                            placeOverlay();
                            setOverlayContrast();
                        });
                    }
                    window.addEventListener('resize', function () {
                        placeOverlay();
                        setOverlayContrast();
                    });
                });
            } catch (e) { }
        });
    </script>
</body>
</html>
